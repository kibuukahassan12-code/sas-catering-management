{% extends "base.html" %}
{% block content %}
<section class="page-header">
    <div style="display: flex; align-items: center; gap: 1.5rem;">
        <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #F26822 0%, #F6BC38 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: white; flex-shrink: 0;">
            {{ client.name[0].upper() }}
        </div>
        <div>
            <p class="eyebrow">CRM ¬∑ Client Profile</p>
            <h1 style="margin: 0.25rem 0;">{{ client.name }}</h1>
            <p class="muted" style="margin: 0;">{{ client.contact_person }} ¬∑ {{ client.email }}</p>
            {% if client.company %}
            <p style="color: rgba(255,255,255,0.7); font-size: 0.875rem; margin: 0.25rem 0 0 0;">{{ client.company }}</p>
            {% endif %}
        </div>
    </div>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
        <a class="btn-primary" href="{{ url_for('core.clients_edit', client_id=client.id) }}">‚úèÔ∏è Edit Client</a>
        <a class="btn-secondary" href="{{ url_for('core.clients_list') }}">‚Üê Back to Clients</a>
        {% if client.is_archived %}
        <form method="post" action="{{ url_for('crm.archive_client', client_id=client.id) }}" style="display: inline;">
            <input type="hidden" name="action" value="unarchive">
            <button type="submit" class="btn-secondary">üì§ Unarchive</button>
        </form>
        {% else %}
        <form method="post" action="{{ url_for('crm.archive_client', client_id=client.id) }}" style="display: inline;" onsubmit="return confirm('Archive this client? They will be hidden from the main list.');">
            <input type="hidden" name="action" value="archive">
            <button type="submit" class="btn-ghost">üì¶ Archive</button>
        </form>
        {% endif %}
    </div>
</section>

<style>
/* Client Profile Styles */
.client-profile-container {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.client-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, rgba(242,104,34,0.15) 0%, rgba(246,188,56,0.1) 100%);
    border: 1px solid rgba(242,104,34,0.3);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(242,104,34,0.2);
}

.stat-card-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.stat-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent, #F6BC38);
    margin: 0.5rem 0;
}

.stat-card-label {
    font-size: 0.875rem;
    color: rgba(255,255,255,0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-card {
    background: rgba(17, 17, 17, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.info-card h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(242,104,34,0.3);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--accent, #F6BC38);
}

.info-item {
    display: flex;
    align-items: flex-start;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.info-item:last-child {
    border-bottom: none;
}

.info-item-label {
    min-width: 140px;
    font-size: 0.875rem;
    color: rgba(255,255,255,0.6);
    font-weight: 500;
}

.info-item-value {
    flex: 1;
    color: rgba(255,255,255,0.9);
    word-break: break-word;
}

.info-item-value a {
    color: var(--accent, #F6BC38);
    text-decoration: none;
    transition: color 0.2s;
}

.info-item-value a:hover {
    color: var(--brand, #F26822);
    text-decoration: underline;
}

.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.tag {
    background: rgba(242,104,34,0.2);
    border: 1px solid rgba(242,104,34,0.4);
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.8125rem;
    color: var(--accent, #F6BC38);
    font-weight: 500;
}

.main-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.tab-container {
    background: rgba(17, 17, 17, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    overflow: hidden;
}

.tabs {
    display: flex;
    gap: 0;
    background: rgba(0, 0, 0, 0.4);
    border-bottom: 2px solid rgba(242,104,34,0.3);
    padding: 0 1rem;
    overflow-x: auto;
}

.tab {
    padding: 1rem 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
    color: rgba(255,255,255,0.6);
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab:hover {
    color: rgba(255,255,255,0.9);
    background: rgba(242,104,34,0.1);
}

.tab.active {
    color: var(--accent, #F6BC38);
    border-bottom-color: var(--brand, #F26822);
    font-weight: 600;
    background: rgba(242,104,34,0.15);
}

.tab-content {
    display: none;
    padding: 1.5rem;
}

.tab-content.active {
    display: block;
}

.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, rgba(242,104,34,0.5), rgba(246,188,56,0.3));
}

.timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
    padding-left: 1.5rem;
    margin-bottom: 1.5rem;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    padding: 1rem 1rem 1rem 3rem;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

.timeline-item:hover {
    border-left-color: var(--brand, #F26822);
    background: rgba(242,104,34,0.1);
}

.timeline-item::after {
    content: '';
    position: absolute;
    left: -5px;
    top: 1rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--brand, #F26822);
    border: 3px solid rgba(17, 17, 17, 0.9);
    box-shadow: 0 0 0 3px rgba(242,104,34,0.3);
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-item-header {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--accent, #F6BC38);
    font-size: 1rem;
}

.timeline-item-meta {
    font-size: 0.8125rem;
    color: rgba(255,255,255,0.5);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.timeline-item-content {
    font-size: 0.9375rem;
    color: rgba(255,255,255,0.8);
    line-height: 1.6;
}

.notes-list {
    max-height: 600px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.note-item {
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 1.25rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: all 0.2s;
}

.note-item:hover {
    border-color: rgba(242,104,34,0.4);
    background: rgba(242,104,34,0.1);
}

.note-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.note-item-author {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--accent, #F6BC38);
}

.note-item-date {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.5);
}

.note-item-content {
    color: rgba(255,255,255,0.9);
    white-space: pre-wrap;
    line-height: 1.6;
}

.documents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1rem;
}

.document-card {
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    transition: all 0.2s;
}

.document-card:hover {
    border-color: rgba(242,104,34,0.5);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(242,104,34,0.2);
}

.document-icon {
    font-size: 3rem;
    margin-bottom: 0.75rem;
    filter: grayscale(0.3);
}

.document-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: rgba(255,255,255,0.9);
    font-size: 0.9375rem;
}

.document-date {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.5);
    margin-bottom: 1rem;
}

.document-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: rgba(255,255,255,0.5);
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.form-section {
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-section h4 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--accent, #F6BC38);
    font-size: 0.9375rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-control-modern {
    margin-bottom: 1rem;
}

.form-control-modern label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: rgba(255,255,255,0.7);
    font-weight: 500;
}

.form-control-modern input,
.form-control-modern select,
.form-control-modern textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(0,0,0,0.5);
    color: var(--text, #f5f5f5);
    font-size: 0.9375rem;
    transition: all 0.2s;
}

.form-control-modern input:focus,
.form-control-modern select:focus,
.form-control-modern textarea:focus {
    outline: none;
    border-color: var(--brand, #F26822);
    background: rgba(0,0,0,0.7);
    box-shadow: 0 0 0 3px rgba(242,104,34,0.2);
}

.form-control-modern textarea {
    resize: vertical;
    min-height: 120px;
    font-family: inherit;
}

.event-table {
    width: 100%;
    border-collapse: collapse;
}

.event-table thead {
    background: rgba(242,104,34,0.2);
}

.event-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--accent, #F6BC38);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid rgba(242,104,34,0.3);
}

.event-table td {
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.9);
}

.event-table tr:hover {
    background: rgba(242,104,34,0.1);
}

.badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-draft { background: rgba(108,117,125,0.3); color: rgba(255,255,255,0.7); }
.badge-confirmed { background: rgba(40,167,69,0.3); color: #28a745; }
.badge-completed { background: rgba(32,201,151,0.3); color: #20c997; }
.badge-cancelled { background: rgba(220,53,69,0.3); color: #dc3545; }

@media (max-width: 1024px) {
    .client-profile-container {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
    }
    
    .page-header {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-icon">üìÖ</div>
        <div class="stat-card-value">{{ events|length }}</div>
        <div class="stat-card-label">Total Events</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon">üßæ</div>
        <div class="stat-card-value">{{ invoices|length }}</div>
        <div class="stat-card-label">Invoices</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon">‚úÖ</div>
        <div class="stat-card-value">{{ open_tasks_count|default(0) }}</div>
        <div class="stat-card-label">Open Tasks</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon">üìù</div>
        <div class="stat-card-value">{{ notes|length if notes else 0 }}</div>
        <div class="stat-card-label">Notes</div>
    </div>
</div>

<div class="client-profile-container">
    <!-- Sidebar -->
    <div class="client-sidebar">
        <div class="info-card">
            <h3>üìû Contact Information</h3>
            <div class="info-item">
                <div class="info-item-label">Contact Person</div>
                <div class="info-item-value">{{ client.contact_person }}</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Email</div>
                <div class="info-item-value"><a href="mailto:{{ client.email }}">{{ client.email }}</a></div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Phone</div>
                <div class="info-item-value"><a href="tel:{{ client.phone }}">{{ client.phone }}</a></div>
            </div>
            {% if client.company %}
            <div class="info-item">
                <div class="info-item-label">Company</div>
                <div class="info-item-value">{{ client.company }}</div>
            </div>
            {% endif %}
            {% if client.address %}
            <div class="info-item">
                <div class="info-item-label">Address</div>
                <div class="info-item-value">{{ client.address }}</div>
            </div>
            {% endif %}
            {% if client.preferred_channel %}
            <div class="info-item">
                <div class="info-item-label">Preferred Channel</div>
                <div class="info-item-value">{{ client.preferred_channel }}</div>
            </div>
            {% endif %}
        </div>

        <div class="info-card">
            <h3>üè∑Ô∏è Tags</h3>
            <form method="post" action="{{ url_for('crm.update_client_tags', client_id=client.id) }}">
                <input type="text" 
                       name="tags" 
                       value="{{ client.tags or '' }}" 
                       placeholder="VIP, Regular, High-value (comma-separated)"
                       class="form-control-modern"
                       style="margin-bottom: 0.75rem;">
                <button type="submit" class="btn-primary" style="width: 100%;">Update Tags</button>
            </form>
            {% if client.tags %}
            <div class="tags-container">
                {% for tag in client.tags.split(',') %}
                <span class="tag">{{ tag.strip() }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% if client.is_archived %}
        <div class="info-card" style="border-color: rgba(220,53,69,0.5); background: rgba(220,53,69,0.1);">
            <h3 style="color: #dc3545;">‚ö†Ô∏è Archived</h3>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.875rem; margin-bottom: 1rem;">This client is archived and hidden from the main list.</p>
            <form method="post" action="{{ url_for('crm.archive_client', client_id=client.id) }}">
                <input type="hidden" name="action" value="unarchive">
                <button type="submit" class="btn-secondary" style="width: 100%;">Unarchive Client</button>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('notes')">
                    <span>üìù</span>
                    <span>Notes</span>
                    {% if notes and notes|length > 0 %}
                    <span style="background: rgba(242,104,34,0.3); padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">{{ notes|length }}</span>
                    {% endif %}
                </button>
                <button class="tab" onclick="showTab('documents')">
                    <span>üìÑ</span>
                    <span>Documents</span>
                    {% if documents and documents|length > 0 %}
                    <span style="background: rgba(242,104,34,0.3); padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">{{ documents|length }}</span>
                    {% endif %}
                </button>
                <button class="tab" onclick="showTab('communications')">
                    <span>üí¨</span>
                    <span>Communications</span>
                    {% if communications and communications|length > 0 %}
                    <span style="background: rgba(242,104,34,0.3); padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">{{ communications|length }}</span>
                    {% endif %}
                </button>
                <button class="tab" onclick="showTab('activity')">
                    <span>üìä</span>
                    <span>Activity Timeline</span>
                    {% if activities and activities|length > 0 %}
                    <span style="background: rgba(242,104,34,0.3); padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">{{ activities|length }}</span>
                    {% endif %}
                </button>
                <button class="tab" onclick="showTab('events')">
                    <span>üìÖ</span>
                    <span>Events History</span>
                    {% if events and events|length > 0 %}
                    <span style="background: rgba(242,104,34,0.3); padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem;">{{ events|length }}</span>
                    {% endif %}
                </button>
            </div>

            <!-- Notes Tab -->
            <div id="notes" class="tab-content active">
                <div class="form-section">
                    <h4>Add New Note</h4>
                    <form method="post" action="{{ url_for('crm.add_client_note', client_id=client.id) }}">
                        <div class="form-control-modern">
                            <textarea name="content" 
                                      rows="5"
                                      placeholder="Add a note about this client..."
                                      required></textarea>
                        </div>
                        <button type="submit" class="btn-primary">‚ûï Add Note</button>
                    </form>
                </div>

                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--accent, #F6BC38);">Notes History</h4>
                    {% if notes and notes|length > 0 %}
                    <div class="notes-list">
                        {% for note in notes %}
                        <div class="note-item">
                            <div class="note-item-header">
                                <span class="note-item-author">üë§ {{ note.user.email }}</span>
                                <span class="note-item-date">{{ note.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                            </div>
                            <div class="note-item-content">{{ note.content }}</div>
                            {% if note.user_id == current_user.id or current_user.is_super_admin() %}
                            <form method="post" action="{{ url_for('crm.delete_client_note', client_id=client.id, note_id=note.id) }}" 
                                  style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);" 
                                  onsubmit="return confirm('Delete this note?');">
                                <button type="submit" class="btn-danger btn-sm">üóëÔ∏è Delete Note</button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No notes yet. Add your first note above.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Documents Tab -->
            <div id="documents" class="tab-content">
                <div class="form-section">
                    <h4>Upload Document</h4>
                    <form method="post" action="{{ url_for('crm.upload_client_document', client_id=client.id) }}" enctype="multipart/form-data">
                        <div class="form-control-modern">
                            <label>Document Title</label>
                            <input type="text" 
                                   name="title" 
                                   placeholder="Enter document title"
                                   required>
                        </div>
                        <div class="form-control-modern">
                            <label>Select File</label>
                            <input type="file" 
                                   name="file" 
                                   required>
                        </div>
                        <button type="submit" class="btn-primary">üì§ Upload Document</button>
                    </form>
                </div>

                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--accent, #F6BC38);">Documents</h4>
                    {% if documents and documents|length > 0 %}
                    <div class="documents-grid">
                        {% for doc in documents %}
                        <div class="document-card">
                            <div class="document-icon">üìÑ</div>
                            <div class="document-title">{{ doc.title }}</div>
                            <div class="document-date">
                                {% if doc.uploaded_at %}
                                {{ doc.uploaded_at.strftime('%b %d, %Y') }}
                                {% else %}
                                Unknown date
                                {% endif %}
                            </div>
                            <div class="document-actions">
                                <a href="{{ url_for('crm.download_client_document', client_id=client.id, doc_id=doc.id) }}" 
                                   class="btn-primary btn-sm">‚¨áÔ∏è Download</a>
                                <form method="post" 
                                      action="{{ url_for('crm.delete_client_document', client_id=client.id, doc_id=doc.id) }}" 
                                      style="display: inline;"
                                      onsubmit="return confirm('Delete this document?');">
                                    <button type="submit" class="btn-danger btn-sm">üóëÔ∏è</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>No documents uploaded yet. Upload your first document above.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Communications Tab -->
            <div id="communications" class="tab-content">
                <div class="form-section">
                    <h4>Record Communication</h4>
                    <form method="post" action="{{ url_for('crm.add_client_communication', client_id=client.id) }}">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-control-modern">
                                <label>Type</label>
                                <select name="communication_type" required>
                                    <option value="Email">üìß Email</option>
                                    <option value="Phone">üìû Phone</option>
                                    <option value="WhatsApp">üí¨ WhatsApp</option>
                                    <option value="SMS">üí≠ SMS</option>
                                    <option value="Meeting">ü§ù Meeting</option>
                                </select>
                            </div>
                            <div class="form-control-modern">
                                <label>Direction</label>
                                <select name="direction" required>
                                    <option value="Outbound">üì§ Outbound</option>
                                    <option value="Inbound">üì• Inbound</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-control-modern">
                            <label>Subject</label>
                            <input type="text" 
                                   name="subject" 
                                   placeholder="Communication subject">
                        </div>
                        <div class="form-control-modern">
                            <label>Related Event (Optional)</label>
                            <select name="event_id">
                                <option value="">No related event</option>
                                {% for event in events %}
                                <option value="{{ event.id }}">{{ event.event_name }} ({{ event.event_date }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-control-modern">
                            <label>Details</label>
                            <textarea name="content" 
                                      rows="5"
                                      placeholder="Communication details..."
                                      required></textarea>
                        </div>
                        <button type="submit" class="btn-primary">üíæ Record Communication</button>
                    </form>
                </div>

                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--accent, #F6BC38);">Communication Timeline</h4>
                    {% if communications and communications|length > 0 %}
                    <div class="timeline">
                        {% for comm in communications %}
                        <div class="timeline-item">
                            <div class="timeline-item-header">
                                {% if comm.communication_type == "Email" %}üìß
                                {% elif comm.communication_type == "Phone" %}üìû
                                {% elif comm.communication_type == "WhatsApp" %}üí¨
                                {% elif comm.communication_type == "SMS" %}üí≠
                                {% elif comm.communication_type == "Meeting" %}ü§ù
                                {% else %}üí¨{% endif %}
                                {{ comm.communication_type }} - {{ comm.direction }}
                                {% if comm.subject %} ¬∑ {{ comm.subject }}{% endif %}
                            </div>
                            <div class="timeline-item-meta">
                                <span>üë§ {{ comm.user.email }}</span>
                                <span>¬∑</span>
                                <span>üïí {{ comm.timestamp.strftime('%b %d, %Y at %I:%M %p') }}</span>
                                {% if comm.event %}
                                <span>¬∑</span>
                                <span>üìÖ Related: {{ comm.event.event_name }}</span>
                                {% endif %}
                            </div>
                            <div class="timeline-item-content">{{ comm.content }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üí¨</div>
                        <p>No communications recorded yet. Record your first communication above.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Activity Timeline Tab -->
            <div id="activity" class="tab-content">
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--accent, #F6BC38);">Activity Timeline</h4>
                    {% if activities and activities|length > 0 %}
                    <div class="timeline">
                        {% for activity in activities %}
                        <div class="timeline-item">
                            <div class="timeline-item-header">
                                {% if activity.activity_type == "Created" %}‚ú®
                                {% elif activity.activity_type == "Note Added" %}üìù
                                {% elif activity.activity_type == "Document Uploaded" %}üìÑ
                                {% elif activity.activity_type == "Tags Updated" %}üè∑Ô∏è
                                {% elif activity.activity_type == "Communication Recorded" %}üí¨
                                {% elif activity.activity_type == "Archived" %}üì¶
                                {% elif activity.activity_type == "Unarchived" %}üì§
                                {% else %}‚ö°{% endif %}
                                {{ activity.activity_type }}
                            </div>
                            <div class="timeline-item-meta">
                                {% if activity.user %}
                                <span>üë§ {{ activity.user.email }}</span>
                                <span>¬∑</span>
                                {% endif %}
                                <span>üïí {{ activity.timestamp.strftime('%b %d, %Y at %I:%M %p') }}</span>
                            </div>
                            <div class="timeline-item-content">{{ activity.description }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>No activity recorded yet. Activity will appear here as you interact with this client.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Events History Tab -->
            <div id="events" class="tab-content">
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--accent, #F6BC38);">Event History</h4>
                    {% if events and events|length > 0 %}
                    <div style="overflow-x: auto;">
                        <table class="event-table">
                            <thead>
                                <tr>
                                    <th>Event Name</th>
                                    <th>Date</th>
                                    <th>Guests</th>
                                    <th>Status</th>
                                    <th>Quote Value</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in events %}
                                <tr>
                                    <td><strong>{{ event.event_name }}</strong></td>
                                    <td>{{ event.event_date.strftime('%b %d, %Y') if event.event_date else 'N/A' }}</td>
                                    <td>{{ event.guest_count }}</td>
                                    <td>
                                        <span class="badge badge-{{ event.status.lower().replace(' ', '-') }}">
                                            {{ event.status }}
                                        </span>
                                    </td>
                                    <td>{{ CURRENCY }}{{ "{:,.2f}".format(event.quoted_value) }}</td>
                                    <td>
                                        <a class="btn-primary btn-sm" href="{{ url_for('core.events_edit', event_id=event.id) }}">View</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No events for this client yet. Events will appear here once they are created.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    const targetTab = document.getElementById(tabName);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // Activate the clicked tab button
    if (event && event.target) {
        let tabButton = event.target.closest('.tab');
        if (tabButton) {
            tabButton.classList.add('active');
        }
    }
}
</script>
{% endblock %}
