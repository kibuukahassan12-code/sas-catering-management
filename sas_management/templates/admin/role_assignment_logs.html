{% extends "base.html" %}
{% block content %}
<section class="page-header">
    <div>
        <p class="eyebrow">Admin · Audit Logs</p>
        <h1>Role Assignment Logs</h1>
        <p class="muted">View audit trail of all role assignments and changes</p>
    </div>
    <a class="btn-secondary" href="{{ url_for('admin.assign_roles') }}">← Back to Role Assignment</a>
</section>

<style>
.filter-section {
    background: rgba(17, 17, 17, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    font-size: 0.875rem;
    color: rgba(255,255,255,0.7);
    font-weight: 500;
}

.filter-group select,
.filter-group input {
    padding: 0.75rem 1rem;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(0,0,0,0.5);
    color: var(--text, #f5f5f5);
    font-size: 0.9375rem;
}

.logs-table {
    background: rgba(17, 17, 17, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    overflow: hidden;
}

.logs-table table {
    width: 100%;
    border-collapse: collapse;
}

.logs-table thead {
    background: rgba(242,104,34,0.1);
    border-bottom: 2px solid rgba(242,104,34,0.3);
}

.logs-table th {
    padding: 1rem;
    text-align: left;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--accent, #F6BC38);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.logs-table td {
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 0.9375rem;
}

.logs-table tbody tr:hover {
    background: rgba(242,104,34,0.05);
}

.badge-log {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 500;
}

.badge-bulk {
    background: rgba(242,104,34,0.2);
    border: 1px solid rgba(242,104,34,0.4);
    color: var(--accent, #F6BC38);
}

.badge-temporary {
    background: rgba(255,193,7,0.2);
    border: 1px solid rgba(255,193,7,0.4);
    color: #ffc107;
}

.badge-admin {
    background: rgba(220,53,69,0.2);
    border: 1px solid rgba(220,53,69,0.4);
    color: #ff6b7a;
}
</style>

<div class="filter-section">
    <form method="GET" class="filter-grid">
        <div class="filter-group">
            <label>Filter by User</label>
            <select name="user_id">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if request.args.get('user_id')|int == user.id %}selected{% endif %}>
                    {{ user.email }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>Filter by Role</label>
            <select name="role_id">
                <option value="">All Roles</option>
                {% for role in roles %}
                <option value="{{ role.id }}" {% if request.args.get('role_id')|int == role.id %}selected{% endif %}>
                    {{ role.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>Filter by Date</label>
            <input type="date" name="date" value="{{ request.args.get('date', '') }}">
        </div>
        <div class="filter-group" style="display: flex; align-items: flex-end;">
            <button type="submit" class="btn-primary" style="width: 100%;">Apply Filters</button>
        </div>
    </form>
</div>

<section class="logs-table">
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Admin User</th>
                <th>Affected User</th>
                <th>Old Role</th>
                <th>New Role</th>
                <th>Type</th>
                <th>Expiry</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else 'N/A' }}</td>
                <td>
                    <strong>{{ log.admin_user.email if log.admin_user else 'System' }}</strong>
                </td>
                <td>
                    <strong>{{ log.affected_user.email if log.affected_user else 'Unknown' }}</strong>
                </td>
                <td>
                    {% if log.old_role %}
                        <span class="badge-log {% if log.old_role.name == 'Admin' %}badge-admin{% endif %}">
                            {{ log.old_role.name }}
                        </span>
                    {% else %}
                        <span class="muted">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if log.new_role %}
                        <span class="badge-log {% if log.new_role.name == 'Admin' %}badge-admin{% endif %}">
                            {{ log.new_role.name }}
                        </span>
                    {% else %}
                        <span class="muted">Removed</span>
                    {% endif %}
                </td>
                <td>
                    {% if log.is_bulk_assignment %}
                        <span class="badge-log badge-bulk">Bulk</span>
                    {% endif %}
                    {% if log.is_temporary %}
                        <span class="badge-log badge-temporary">Temporary</span>
                    {% endif %}
                    {% if not log.is_bulk_assignment and not log.is_temporary %}
                        <span class="muted">Single</span>
                    {% endif %}
                </td>
                <td>
                    {% if log.expiry_date %}
                        {{ log.expiry_date.strftime('%Y-%m-%d') }}
                    {% else %}
                        <span class="muted">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if log.notes %}
                        <small style="color: rgba(255,255,255,0.6);">{{ log.notes[:50] }}{% if log.notes|length > 50 %}...{% endif %}</small>
                    {% else %}
                        <span class="muted">—</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 3rem;">
                    <p class="muted">No role assignment logs found.</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endblock %}

