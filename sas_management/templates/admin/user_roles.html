{% extends "base.html" %}
{% block content %}
<section class="page-header">
    <div>
        <p class="eyebrow">Admin ¬∑ User Management</p>
        <h1>User Role Assignment</h1>
        <p class="muted">Assign and manage user access securely</p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a class="btn-primary" href="{{ url_for('admin.users_add') }}">+ Add User</a>
        <a class="btn-secondary" href="{{ url_for('admin.role_assignment_logs') }}">View Audit Logs</a>
        <a class="btn-secondary" href="{{ url_for('admin.dashboard') }}">‚Üê Admin Dashboard</a>
    </div>
</section>

<style>
.role-assignment-container {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 1.5rem;
}

.role-assignment-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-section {
    background: rgba(17, 17, 17, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.5rem;
}

.form-section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(242,104,34,0.3);
}

.form-section-header h3 {
    margin: 0;
    font-size: 1.125rem;
    color: var(--accent, #F6BC38);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.form-section-header-icon {
    font-size: 1.5rem;
}

.form-grid-modern {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 0.875rem;
    color: rgba(255,255,255,0.7);
    font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(0,0,0,0.5);
    color: var(--text, #f5f5f5);
    font-size: 0.9375rem;
    transition: all 0.2s;
    font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--brand, #F26822);
    background: rgba(0,0,0,0.7);
    box-shadow: 0 0 0 3px rgba(242,104,34,0.2);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.form-group small {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.5);
    margin-top: -0.25rem;
}

.user-select-container {
    position: relative;
}

.user-select-multi {
    min-height: 120px;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    background: rgba(0,0,0,0.5);
    padding: 0.5rem;
}

.user-select-multi option {
    padding: 0.5rem;
    margin: 0.25rem 0;
    border-radius: 4px;
    background: rgba(255,255,255,0.05);
}

.user-select-multi option:checked {
    background: rgba(242,104,34,0.3);
    color: var(--accent, #F6BC38);
}

.toggle-switch {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(242,104,34,0.1);
    border: 1px solid rgba(242,104,34,0.3);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.toggle-switch:hover {
    background: rgba(242,104,34,0.15);
    border-color: rgba(242,104,34,0.5);
}

.toggle-switch input[type="checkbox"] {
    width: 48px;
    height: 24px;
    appearance: none;
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: all 0.2s;
}

.toggle-switch input[type="checkbox"]:checked {
    background: var(--brand, #F26822);
}

.toggle-switch input[type="checkbox"]::before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    top: 2px;
    left: 2px;
    transition: all 0.2s;
}

.toggle-switch input[type="checkbox"]:checked::before {
    left: 26px;
}

.toggle-switch label {
    cursor: pointer;
    margin: 0;
    font-weight: 500;
    color: rgba(255,255,255,0.9);
}

.temp-fields {
    display: none;
    grid-column: 1 / -1;
    gap: 1rem;
    margin-top: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.temp-fields.active {
    display: grid;
}

.btn-primary-modern {
    background: var(--brand, #F26822);
    border: none;
    color: #000;
    padding: 1rem;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
}

.btn-primary-modern:hover:not(:disabled) {
    background: #e67600;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(242,104,34,0.3);
}

.btn-primary-modern:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.role-summary {
    position: sticky;
    top: 1rem;
    height: fit-content;
    background: rgba(17, 17, 17, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.5rem;
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(242,104,34,0.3);
}

.summary-header h3 {
    margin: 0;
    font-size: 1.125rem;
    color: var(--accent, #F6BC38);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-label {
    color: rgba(255,255,255,0.7);
    font-size: 0.875rem;
}

.summary-value {
    color: rgba(255,255,255,0.9);
    font-weight: 500;
    text-align: right;
    max-width: 60%;
    word-wrap: break-word;
}

.selected-users-list {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: rgba(0,0,0,0.3);
    border-radius: 6px;
}

.selected-user-item {
    padding: 0.375rem 0.5rem;
    margin: 0.25rem 0;
    background: rgba(242,104,34,0.2);
    border-radius: 4px;
    font-size: 0.8125rem;
}

@media (max-width: 1024px) {
    .role-assignment-container {
        grid-template-columns: 1fr;
    }
    
    .role-summary {
        position: relative;
        top: 0;
    }
}

@media (max-width: 768px) {
    .form-grid-modern {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="role-assignment-container">
    <div class="role-assignment-main">
        <form method="POST" id="roleAssignmentForm" action="{{ url_for('admin.bulk_assign_role') }}" onsubmit="return validateFormSubmission(event);">
            <div class="form-section">
                <div class="form-section-header">
                    <span class="form-section-header-icon">üë•</span>
                    <h3>Assign Role</h3>
    </div>
                
                <div class="form-grid-modern">
                    <div class="form-group full-width">
                        <label>Select Users <span style="color: #dc3545;">*</span></label>
                        <select name="user_ids" id="userSelect" multiple class="user-select-multi" required onchange="updateSummary()">
                {% for user in users %}
                            <option value="{{ user.id }}" 
                                    data-email="{{ user.email }}"
                                    data-current-role="{{ user.role_obj.name if user.role_obj else 'No role' }}"
                                    data-is-admin="{% if user.is_admin %}true{% else %}false{% endif %}">
                                {{ user.email }} - {{ user.role_obj.name if user.role_obj else 'No role' }}
                            </option>
                            {% endfor %}
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple users for bulk assignment</small>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Select Role <span style="color: #dc3545;">*</span></label>
                        <select name="role_id" id="roleSelect" required onchange="updateSummary()">
                            <option value="">‚Äî Select Role ‚Äî</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}" data-role-name="{{ role.name }}" data-is-admin="{% if role.name == 'Admin' or role.name == 'ADMIN' %}true{% else %}false{% endif %}">
                                {% if role.name == 'Admin' or role.name == 'ADMIN' %}
                                    ADMIN (System ‚Äì Full Access)
                        {% else %}
                                    {{ role.name }}
                                {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <div class="toggle-switch" onclick="toggleTemporaryFields()">
                            <input type="checkbox" id="isTemporary" name="is_temporary" value="true" onchange="toggleTemporaryFields()">
                            <label for="isTemporary">Temporary Assignment</label>
                        </div>
                    </div>
                    
                    <div class="form-grid-modern temp-fields" id="tempFields">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" name="start_date" id="startDate" value="{{ datetime.utcnow().date().isoformat() }}">
                        </div>
                        <div class="form-group">
                            <label>End Date <span style="color: #dc3545;">*</span></label>
                            <input type="date" name="expiry_date" id="expiryDate" min="{{ datetime.utcnow().date().isoformat() }}">
                            <small>Role will automatically revert after this date</small>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Assignment Notes (Optional)</label>
                        <textarea name="notes" id="assignmentNotes" placeholder="Add notes for audit logging (e.g., reason for assignment, special permissions, etc.)"></textarea>
                        <small>These notes will be recorded in the audit log</small>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.08);">
                    <button type="submit" class="btn-primary-modern" id="assignButton" disabled>
                        ‚úÖ Assign Role
                    </button>
                </div>
            </div>
                        </form>
    </div>

    <!-- Assignment Summary Sidebar -->
    <div class="role-summary">
        <div class="summary-header">
            <span>üìä</span>
            <h3>Assignment Summary</h3>
        </div>
        
        <div id="summaryContent">
            <div class="summary-row">
                <span class="summary-label">Selected Users:</span>
                <span class="summary-value" id="selectedUsersCount">0</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">New Role:</span>
                <span class="summary-value" id="selectedRole">‚Äî</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Temporary:</span>
                <span class="summary-value" id="temporaryStatus">No</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Expiry Date:</span>
                <span class="summary-value" id="expiryDateDisplay">‚Äî</span>
            </div>
        </div>
        
        <div id="selectedUsersList" class="selected-users-list" style="display: none; margin-top: 1rem;">
            <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem; font-weight: 500;">Selected Users:</div>
            <div id="selectedUsersItems"></div>
        </div>
        
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 0.8125rem; color: rgba(255,255,255,0.6); line-height: 1.6;">
                <strong style="color: var(--accent, #F6BC38);">üí° Note:</strong><br>
                ADMIN role cannot be removed or downgraded. Users with ADMIN role have full system access and bypass all permission checks.
    </div>
        </div>
    </div>
</div>

<script>
// Toggle temporary assignment fields
function toggleTemporaryFields() {
    const checkbox = document.getElementById('isTemporary');
    const tempFields = document.getElementById('tempFields');
    if (checkbox.checked) {
        tempFields.classList.add('active');
        document.getElementById('expiryDate').required = true;
    } else {
        tempFields.classList.remove('active');
        document.getElementById('expiryDate').required = false;
    }
    updateSummary();
}

// Update summary panel
function updateSummary() {
    const userSelect = document.getElementById('userSelect');
    const roleSelect = document.getElementById('roleSelect');
    const isTemporary = document.getElementById('isTemporary').checked;
    const expiryDate = document.getElementById('expiryDate').value;
    
    // Get selected users
    const selectedUsers = Array.from(userSelect.selectedOptions);
    const selectedUsersCount = selectedUsers.length;
    
    // Get selected role
    const selectedRoleOption = roleSelect.options[roleSelect.selectedIndex];
    const selectedRole = selectedRoleOption.value ? selectedRoleOption.text : '‚Äî';
    
    // Update summary display
    document.getElementById('selectedUsersCount').textContent = selectedUsersCount;
    document.getElementById('selectedRole').textContent = selectedRole;
    document.getElementById('temporaryStatus').textContent = isTemporary ? 'Yes' : 'No';
    document.getElementById('expiryDateDisplay').textContent = isTemporary && expiryDate ? expiryDate : '‚Äî';
    
    // Update selected users list
    const usersList = document.getElementById('selectedUsersList');
    const usersItems = document.getElementById('selectedUsersItems');
    
    if (selectedUsersCount > 0) {
        usersList.style.display = 'block';
        usersItems.innerHTML = selectedUsers.map(option => {
            const email = option.dataset.email;
            const currentRole = option.dataset.currentRole;
            const isAdmin = option.dataset.isAdmin === 'true';
            return `<div class="selected-user-item" style="${isAdmin ? 'border-left: 3px solid #dc3545;' : ''}">
                ${email} <span style="color: rgba(255,255,255,0.6);">(${currentRole})</span>
            </div>`;
        }).join('');
    } else {
        usersList.style.display = 'none';
    }
    
    // Enable/disable assign button
    const assignButton = document.getElementById('assignButton');
    if (selectedUsersCount > 0 && roleSelect.value) {
        assignButton.disabled = false;
        
        // Check if trying to assign ADMIN role
        const isAdminRole = selectedRoleOption.dataset.isAdmin === 'true';
        if (isAdminRole) {
            assignButton.textContent = '‚ö†Ô∏è Assign ADMIN Role';
        } else {
            assignButton.textContent = '‚úÖ Assign Role';
        }
    } else {
        assignButton.disabled = true;
    }
}

// Form submission with validation
function validateFormSubmission(e) {
    const userSelect = document.getElementById('userSelect');
    const roleSelect = document.getElementById('roleSelect');
    const selectedUsers = Array.from(userSelect.selectedOptions);
    const selectedRoleOption = roleSelect.options[roleSelect.selectedIndex];
    const isAdminRole = selectedRoleOption.dataset.isAdmin === 'true';
    const isTemporary = document.getElementById('isTemporary').checked;
    const expiryDate = document.getElementById('expiryDate').value;
    
    // Validation
    if (selectedUsers.length === 0) {
        e.preventDefault();
        alert('Please select at least one user.');
        return false;
    }
    
    if (!roleSelect.value) {
        e.preventDefault();
        alert('Please select a role.');
        return false;
    }
    
    if (isTemporary && !expiryDate) {
        e.preventDefault();
        alert('Please provide an expiry date for temporary assignments.');
        return false;
    }
    
    // Check for ADMIN role protection
    if (isAdminRole) {
        if (!confirm('‚ö†Ô∏è WARNING: You are about to assign the ADMIN role. This grants full system access. Continue?')) {
            e.preventDefault();
            return false;
        }
    }
    
    // Check if trying to remove admin from current user
    const currentUserId = {{ current_user.id }};
    const hasCurrentUser = selectedUsers.some(option => parseInt(option.value) === currentUserId);
    if (hasCurrentUser && isAdminRole === false) {
        const currentUserOption = selectedUsers.find(option => parseInt(option.value) === currentUserId);
        if (currentUserOption && currentUserOption.dataset.isAdmin === 'true') {
            e.preventDefault();
            alert('You cannot remove or downgrade your own Admin role.');
            return false;
        }
    }
    
    // Prepare form data - set user_ids as comma-separated string
    const userIds = selectedUsers.map(option => option.value).join(',');
    const userIdsInput = document.createElement('input');
    userIdsInput.type = 'hidden';
    userIdsInput.name = 'user_ids';
    userIdsInput.value = userIds;
    e.target.appendChild(userIdsInput);
    
    return true;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSummary();
    
    // Set minimum date to today for expiry date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expiryDate').setAttribute('min', today);
});
</script>
{% endblock %}
