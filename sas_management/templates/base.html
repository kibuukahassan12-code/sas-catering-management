{% set _ = none %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#D97706">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SAS">
    <meta name="description" content="SAS Management System - Complete event management and catering system">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ url_for('static', filename='images/icon-512x512.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192x192.png') }}">
    
    <title>{{ title or "SAS Management System" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="pwa-body">
    <!-- Loading Skeleton -->
    <div id="loading-skeleton" class="loading-skeleton">
        <div class="skeleton-header"></div>
        <div class="skeleton-content">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
        </div>
    </div>

    <!-- App Shell: Sticky Top Bar -->
    <header class="app-topbar" id="app-topbar">
        {% if current_user.is_authenticated %}
        <button class="app-menu-toggle" id="app-menu-toggle" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        {% endif %}
        <a href="{{ url_for('core.dashboard') if current_user.is_authenticated else url_for('core.login') }}" class="app-brand">
            <img src="{{ url_for('static', filename='images/ssas_logo.png') }}" alt="SAS" class="app-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
            <span class="app-logo-text" style="display: none;">SAS</span>
            <span class="app-brand-name">SAS</span>
        </a>
        {% if current_user.is_authenticated %}
        <div class="app-user-menu-wrapper">
            <button class="app-user-btn" onclick="toggleAppUserMenu()" aria-label="User menu">
                <span class="app-user-avatar">{{ current_user.email[0].upper() }}</span>
            </button>
            <div id="app-user-menu" class="app-user-menu">
                <div class="app-user-info">
                    <strong>{{ current_user.email }}</strong>
                    <small>{{ current_user.get_role_name() }}</small>
                </div>
                <a href="{{ url_for('auth.change_password') }}">ğŸ”’ Change Password</a>
                <a href="{{ url_for('core.logout') }}">ğŸšª Logout</a>
            </div>
        </div>
        {% endif %}
    </header>


    {% if current_user.is_authenticated %}
    <!-- Side Navigation Drawer -->
    <div class="app-drawer-overlay" id="app-drawer-overlay"></div>
    <nav class="app-drawer" id="app-drawer">
        <div class="app-drawer-header">
            <h3>Navigation</h3>
            <button class="app-drawer-close" id="app-drawer-close" aria-label="Close">Ã—</button>
        </div>
        <div class="app-drawer-content">
            {% if current_user.is_authenticated %}
            <ul class="app-nav-menu">
                <li class="app-nav-item">
                    <a href="{{ url_for('university.dashboard') }}" class="app-nav-link">
                        ğŸ“ Employee University
                    </a>
                </li>
                {% if current_user.is_admin %}
                <li class="app-nav-item">
                    <a href="{{ url_for('admin.dashboard') }}" class="app-nav-link">
                        <span class="app-nav-icon">ğŸ›¡ï¸</span>
                        <span class="app-nav-text">Admin Dashboard</span>
                    </a>
                </li>
                {% endif %}
                {% if current_user.is_authenticated %}
                <li class="app-nav-item">
                    <a href="{{ url_for('ai.chat') }}" class="app-nav-link">
                        <span class="app-nav-icon">ğŸ¤–</span>
                        <span class="app-nav-text">SAS AI</span>
                    </a>
                </li>
                {% endif %}
            </ul>
            {% endif %}
            {% if modules %}
            <ul class="app-nav-menu">
                {% for module in modules %}
                <li class='app-nav-item'>
                    {% if module.children is defined %}
                    <div class='app-nav-parent'>
                        <a href='{{ module.url }}' class='app-nav-link'>{{ module.name }}</a>
                        <button class='app-nav-toggle' onclick='toggleAppSubmenu(this)'>â–¼</button>
                    </div>
                    <ul class='app-nav-submenu'>
                        {% for child in module.children %}
                        <li><a href='{{ child.url }}'>{{ child.name }}</a></li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <a href='{{ module.url }}' class='app-nav-link'>{{ module.name }}</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    </nav>
    {% endif %}

    <!-- Flash Messages Removed - Silent Backend Handling -->

    <!-- Main Content -->
    <main class="app-main" id="app-main">
        {% block content %}{% endblock %}
    </main>

    {% if current_user.is_authenticated %}
    <!-- Bottom Navigation Bar (Mobile) -->
    <nav class="app-bottom-nav" id="app-bottom-nav">
        <a href="{{ url_for('core.dashboard') }}" class="app-bottom-nav-item" data-page="dashboard">
            <span class="app-bottom-nav-icon">ğŸ“Š</span>
            <span class="app-bottom-nav-label">Dashboard</span>
        </a>
        <a href="{{ url_for('events.events_list') }}" class="app-bottom-nav-item" data-page="events">
            <span class="app-bottom-nav-icon">ğŸ“…</span>
            <span class="app-bottom-nav-label">Events</span>
        </a>
        <a href="{{ url_for('catering.menu_list') }}" class="app-bottom-nav-item" data-page="catering">
            <span class="app-bottom-nav-icon">ğŸ½ï¸</span>
            <span class="app-bottom-nav-label">Catering</span>
        </a>
        <a href="{{ url_for('hire.orders_list') }}" class="app-bottom-nav-item" data-page="hire">
            <span class="app-bottom-nav-icon">ğŸ“¦</span>
            <span class="app-bottom-nav-label">Hire</span>
        </a>
        <a href="{{ url_for('admin.users_list') if current_user.is_super_admin() else url_for('auth.change_password') }}" class="app-bottom-nav-item" data-page="profile">
            <span class="app-bottom-nav-icon">ğŸ‘¤</span>
            <span class="app-bottom-nav-label">Profile</span>
        </a>
    </nav>
    {% endif %}

    <!-- Service Worker Registration -->
    <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('{{ url_for("static", filename="service-worker.js") }}')
                .then((registration) => {
                    console.log('Service Worker registered:', registration.scope);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New service worker available
                                if (confirm('New version available! Reload to update?')) {
                                    window.location.reload();
                                }
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.error('Service Worker registration failed:', error);
                });
        });
    }

    // App Shell Functions
    function toggleAppDrawer() {
        const drawer = document.getElementById('app-drawer');
        const overlay = document.getElementById('app-drawer-overlay');
        const toggle = document.getElementById('app-menu-toggle');
        
        if (drawer && overlay && toggle) {
            const isOpen = drawer.classList.contains('active');
            if (isOpen) {
                drawer.classList.remove('active');
                overlay.classList.remove('active');
                toggle.classList.remove('active');
                document.body.style.overflow = '';
            } else {
                drawer.classList.add('active');
                overlay.classList.add('active');
                toggle.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
    }

    function toggleAppSubmenu(button) {
        const item = button.closest('.app-nav-item');
        if (item) {
            item.classList.toggle('active');
        }
    }

    function toggleAppUserMenu() {
        const menu = document.getElementById('app-user-menu');
        if (menu) {
            menu.classList.toggle('active');
        }
    }

    // Hide loading skeleton when page loads
    window.addEventListener('load', () => {
        const skeleton = document.getElementById('loading-skeleton');
        if (skeleton) {
            skeleton.style.opacity = '0';
            setTimeout(() => {
                skeleton.style.display = 'none';
            }, 300);
        }
    });

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        // Drawer controls
        const overlay = document.getElementById('app-drawer-overlay');
        const closeBtn = document.getElementById('app-drawer-close');
        const toggle = document.getElementById('app-menu-toggle');
        
        if (overlay) overlay.addEventListener('click', toggleAppDrawer);
        if (closeBtn) closeBtn.addEventListener('click', toggleAppDrawer);
        if (toggle) toggle.addEventListener('click', toggleAppDrawer);
        
        // Close user menu when clicking outside
        document.addEventListener('click', function(event) {
            const userMenu = document.getElementById('app-user-menu');
            const userMenuBtn = document.querySelector('.app-user-btn');
            if (userMenu && userMenuBtn && 
                !userMenu.contains(event.target) && 
                !userMenuBtn.contains(event.target)) {
                userMenu.classList.remove('active');
            }
        });

        // Highlight active bottom nav item
        const currentPath = window.location.pathname;
        const bottomNavItems = document.querySelectorAll('.app-bottom-nav-item');
        bottomNavItems.forEach(item => {
            if (currentPath.includes(item.getAttribute('data-page'))) {
                item.classList.add('active');
            }
        });
    });

    // (Global app search UI removed; backend search APIs remain available for page-level UIs)
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
