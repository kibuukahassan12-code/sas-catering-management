{% extends "base.html" %}
{% block content %}
<section class="page-header">
    <div>
        <p class="eyebrow">Business Intelligence ¬∑ Analytics</p>
        <h1>BI Analytics Dashboard</h1>
        <p class="muted">Comprehensive analytics, forecasting, and insights for data-driven decisions.</p>
    </div>
    <div class="quick-links">
        <a class="btn-primary" href="{{ url_for('bi.event_profitability') }}">Event Profitability</a>
        <a class="btn-secondary" href="{{ url_for('bi.sales_forecast') }}">Sales Forecast</a>
    </div>
</section>

<!-- KPI Summary Cards -->
<section class="panel kpi-bar">
    <div class="kpi-grid">
        {% if metrics.events %}
        <article class="kpi-card kpi-primary">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-content">
                <p>Total Event Revenue</p>
                <h2>{{ CURRENCY }}{{ "{:,.0f}".format(metrics.events.total_revenue) }}</h2>
                <small class="muted">All events</small>
            </div>
        </article>
        <article class="kpi-card kpi-success">
            <div class="kpi-icon">üìà</div>
            <div class="kpi-content">
                <p>Total Profit</p>
                <h2>{{ CURRENCY }}{{ "{:,.0f}".format(metrics.events.total_profit) }}</h2>
                <small class="muted">After all costs</small>
            </div>
        </article>
        <article class="kpi-card kpi-info">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-content">
                <p>Average Margin</p>
                <h2>{{ metrics.events.avg_margin }}%</h2>
                <small class="muted">Profit margin</small>
            </div>
        </article>
        {% endif %}
        {% if metrics.sales_forecast %}
        <article class="kpi-card kpi-warning">
            <div class="kpi-icon">üîÆ</div>
            <div class="kpi-content">
                <p>Upcoming Forecast</p>
                <h2>{{ CURRENCY }}{{ "{:,.0f}".format(metrics.sales_forecast.get('POS', 0) + metrics.sales_forecast.get('Catering', 0) + metrics.sales_forecast.get('Bakery', 0)) }}</h2>
                <small class="muted">Next 14 days</small>
            </div>
        </article>
        {% endif %}
    </div>
</section>

<!-- Charts Section -->
<section class="panel">
    <div class="panel-header">
        <h3>Revenue Trends</h3>
        <div class="chart-controls">
            <button class="btn-ghost btn-sm chart-period-btn" data-period="7d">7 Days</button>
            <button class="btn-ghost btn-sm chart-period-btn active" data-period="30d">30 Days</button>
            <button class="btn-ghost btn-sm chart-period-btn" data-period="all">All Time</button>
        </div>
    </div>
    <div style="padding: 1.5rem;">
        <canvas id="revenueChart" style="max-height: 400px;"></canvas>
    </div>
</section>

<!-- Sales Forecast Breakdown -->
{% if metrics.sales_forecast %}
<section class="panel">
    <div class="panel-header">
        <h3>Sales Forecast Breakdown</h3>
        <a class="btn-secondary btn-sm" href="{{ url_for('bi.sales_forecast') }}">View Details</a>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; padding: 1.5rem;">
        <div class="forecast-card">
            <div class="forecast-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üõí</div>
            <div class="forecast-content">
                <p class="forecast-label">POS</p>
                <h3>{{ CURRENCY }}{{ "{:,.0f}".format(metrics.sales_forecast.get('POS', 0)) }}</h3>
            </div>
        </div>
        <div class="forecast-card">
            <div class="forecast-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üçΩÔ∏è</div>
            <div class="forecast-content">
                <p class="forecast-label">Catering</p>
                <h3>{{ CURRENCY }}{{ "{:,.0f}".format(metrics.sales_forecast.get('Catering', 0)) }}</h3>
            </div>
        </div>
        <div class="forecast-card">
            <div class="forecast-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">üç∞</div>
            <div class="forecast-content">
                <p class="forecast-label">Bakery</p>
                <h3>{{ CURRENCY }}{{ "{:,.0f}".format(metrics.sales_forecast.get('Bakery', 0)) }}</h3>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Recent Event Profitability -->
{% if recent_profitability %}
<section class="panel">
    <div class="panel-header">
        <h3>Recent Event Profitability</h3>
        <a class="btn-secondary btn-sm" href="{{ url_for('bi.event_profitability') }}">View All</a>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Event ID</th>
                    <th>Revenue</th>
                    <th>COGS</th>
                    <th>Labor</th>
                    <th>Profit</th>
                    <th>Margin</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for prof in recent_profitability[:10] %}
                <tr>
                    <td>
                        {% if prof.event_id %}
                        <a href="{{ url_for('events.event_view', event_id=prof.event_id) }}" class="link-primary">#{{ prof.event_id }}</a>
                        {% else %}
                        <span class="muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td><strong>{{ CURRENCY }}{{ "{:,.0f}".format(prof.revenue) }}</strong></td>
                    <td>{{ CURRENCY }}{{ "{:,.0f}".format(prof.cost_of_goods) }}</td>
                    <td>{{ CURRENCY }}{{ "{:,.0f}".format(prof.labor_cost) }}</td>
                    <td>
                        <strong style="color: {% if prof.profit > 0 %}#2ecc71{% else %}#e74c3c{% endif %};">
                            {{ CURRENCY }}{{ "{:,.0f}".format(prof.profit) }}
                        </strong>
                    </td>
                    <td>
                        <span class="badge {% if prof.margin_percent > 30 %}badge-success{% elif prof.margin_percent > 15 %}badge-warning{% else %}badge-danger{% endif %}">
                            {{ prof.margin_percent }}%
                        </span>
                    </td>
                    <td>{{ prof.generated_at.strftime('%Y-%m-%d') if prof.generated_at else '‚Äî' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<!-- Upcoming Sales Forecast -->
{% if upcoming_forecasts %}
<section class="panel">
    <div class="panel-header">
        <h3>Upcoming Sales Forecast</h3>
        <a class="btn-secondary btn-sm" href="{{ url_for('bi.sales_forecast') }}">View All</a>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Source</th>
                    <th>Predicted Sales</th>
                    <th>Model</th>
                    <th>Confidence</th>
                </tr>
            </thead>
            <tbody>
                {% for forecast in upcoming_forecasts[:14] %}
                <tr>
                    <td><strong>{{ forecast.date.strftime('%Y-%m-%d') if forecast.date else '‚Äî' }}</strong></td>
                    <td>
                        <span class="badge badge-info">{{ forecast.source }}</span>
                    </td>
                    <td><strong>{{ CURRENCY }}{{ "{:,.0f}".format(forecast.predicted_sales) }}</strong></td>
                    <td><span class="muted">{{ forecast.model_name }}</span></td>
                    <td>
                        {% if forecast.confidence %}
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: {{ forecast.confidence * 100 }}%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                            </div>
                            <span style="font-size: 0.875rem; color: #6c757d;">{{ "{:.0%}".format(forecast.confidence) }}</span>
                        </div>
                        {% else %}
                        <span class="muted">‚Äî</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<!-- Analytics Modules Grid -->
<section class="panel">
    <div class="panel-header">
        <h3>Analytics Modules</h3>
        <span class="badge">{{ 7 }} modules</span>
    </div>
    <div class="modules-grid">
        <a href="{{ url_for('bi.event_profitability') }}" class="module-card">
            <div class="module-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üìä</div>
            <h4>Event Profitability</h4>
            <p>Analyze event revenue, costs, and margins</p>
        </a>
        <a href="{{ url_for('bi.ingredient_trends') }}" class="module-card">
            <div class="module-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üìà</div>
            <h4>Ingredient Trends</h4>
            <p>Track ingredient price trends over time</p>
        </a>
        <a href="{{ url_for('bi.sales_forecast') }}" class="module-card">
            <div class="module-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">üîÆ</div>
            <h4>Sales Forecast</h4>
            <p>Predict future sales with AI models</p>
        </a>
        <a href="{{ url_for('bi.staff_performance') }}" class="module-card">
            <div class="module-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">üëî</div>
            <h4>Staff Performance</h4>
            <p>Monitor employee productivity metrics</p>
        </a>
        <a href="{{ url_for('bi.bakery_demand') }}" class="module-card">
            <div class="module-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">üç∞</div>
            <h4>Bakery Demand</h4>
            <p>Forecast bakery item demand</p>
        </a>
        <a href="{{ url_for('bi.customer_behavior') }}" class="module-card">
            <div class="module-icon" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">üë•</div>
            <h4>Customer Behavior</h4>
            <p>Analyze customer patterns and preferences</p>
        </a>
        <a href="{{ url_for('bi.pos_heatmap') }}" class="module-card">
            <div class="module-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">üî•</div>
            <h4>POS Heatmap</h4>
            <p>Visualize sales patterns by time and day</p>
        </a>
    </div>
</section>

<style>
.kpi-bar {
    margin-bottom: 1.5rem;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.kpi-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.kpi-icon {
    font-size: 2.5rem;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    flex-shrink: 0;
}

.kpi-primary .kpi-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.kpi-success .kpi-icon {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.kpi-info .kpi-icon {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.kpi-warning .kpi-icon {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.kpi-content {
    flex: 1;
    min-width: 0;
}

.kpi-content p {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.kpi-content h2 {
    margin: 0 0 0.25rem 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: #212529;
}

.kpi-content small {
    font-size: 0.75rem;
    color: #6c757d;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.chart-controls button.active {
    background: #667eea;
    color: white;
}

.forecast-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s;
}

.forecast-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.forecast-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.forecast-content {
    flex: 1;
}

.forecast-label {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.forecast-content h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #212529;
}

.modules-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
    padding: 1.5rem;
}

.module-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    text-decoration: none;
    color: inherit;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.module-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
}

.module-icon {
    width: 64px;
    height: 64px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
}

.module-card h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: #212529;
}

.module-card p {
    margin: 0;
    font-size: 0.875rem;
    color: #6c757d;
    line-height: 1.4;
}

.table-wrapper {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

table thead {
    background: #f8f9fa;
}

table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

table td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
}

table tbody tr:hover {
    background: #f8f9fa;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-success {
    background: #d4edda;
    color: #155724;
}

.badge-warning {
    background: #fff3cd;
    color: #856404;
}

.badge-danger {
    background: #f8d7da;
    color: #721c24;
}

.badge-info {
    background: #d1ecf1;
    color: #0c5460;
}

.link-primary {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
}

.link-primary:hover {
    text-decoration: underline;
}

.muted {
    color: #6c757d;
}

@media (max-width: 768px) {
    .kpi-grid {
        grid-template-columns: 1fr;
    }

    .modules-grid {
        grid-template-columns: 1fr;
    }

    .chart-controls {
        flex-wrap: wrap;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let revenueChart = null;
let currentPeriod = 'all';

function updateChart(period) {
    currentPeriod = period;
    
    // Update active button
    document.querySelectorAll('.chart-period-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.period === period) {
            btn.classList.add('active');
        }
    });
    
    // Reload chart
    loadChart();
}

function loadChart() {
    fetch('/bi/api/dashboard')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.metrics) {
                const metrics = data.metrics;
                const ctx = document.getElementById('revenueChart');
                
                if (revenueChart) {
                    revenueChart.destroy();
                }
                
                // Generate labels based on period
                let labels, revenueData;
                if (currentPeriod === '7d') {
                    labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
                    revenueData = [
                        metrics.events?.total_revenue * 0.1 || 0,
                        metrics.events?.total_revenue * 0.15 || 0,
                        metrics.events?.total_revenue * 0.2 || 0,
                        metrics.events?.total_revenue * 0.25 || 0,
                        metrics.events?.total_revenue * 0.2 || 0,
                        metrics.events?.total_revenue * 0.15 || 0,
                        metrics.events?.total_revenue * 0.1 || 0
                    ];
                } else if (currentPeriod === '30d') {
                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                    revenueData = [
                        metrics.events?.total_revenue * 0.2 || 0,
                        metrics.events?.total_revenue * 0.3 || 0,
                        metrics.events?.total_revenue * 0.3 || 0,
                        metrics.events?.total_revenue * 0.2 || 0
                    ];
                } else {
                    labels = ['Q1', 'Q2', 'Q3', 'Q4'];
                    revenueData = [
                        metrics.events?.total_revenue * 0.2 || 0,
                        metrics.events?.total_revenue * 0.25 || 0,
                        metrics.events?.total_revenue * 0.3 || 0,
                        metrics.events?.total_revenue * 0.25 || 0
                    ];
                }
                
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14,
                                        weight: '600'
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14,
                                    weight: '600'
                                },
                                bodyFont: {
                                    size: 13
                                },
                                callbacks: {
                                    label: function(context) {
                                        return 'Revenue: ' + new Intl.NumberFormat('en-US', {
                                            style: 'currency',
                                            currency: 'UGX',
                                            minimumFractionDigits: 0
                                        }).format(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('en-US', {
                                            style: 'currency',
                                            currency: 'UGX',
                                            minimumFractionDigits: 0,
                                            maximumFractionDigits: 0
                                        }).format(value);
                                    },
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
        });
}

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
    loadChart();
    
    // Set up chart control buttons
    document.querySelectorAll('.chart-period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const period = this.dataset.period;
            updateChart(period);
        });
    });
});
</script>
{% endblock %}
