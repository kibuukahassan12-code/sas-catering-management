{% extends "base.html" %}
{% block title %}Floor Plan Builder - SAS Best Foods{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/floorplan_builder.css') }}">
<script src="https://cdn.jsdelivr.net/npm/konva@9.2.0/konva.min.js"></script>

<div class="floorplan-builder">
    <!-- Top Action Bar -->
    <div class="action-bar">
        <div class="action-group">
            <button id="btn-undo" class="action-btn" title="Undo (Ctrl+Z)">
                <span>‚Ü∂</span> Undo
            </button>
            <button id="btn-redo" class="action-btn" title="Redo (Ctrl+Y)">
                <span>‚Ü∑</span> Redo
            </button>
        </div>
        <div class="action-group">
            <button id="btn-zoom-out" class="action-btn" title="Zoom Out">‚àí</button>
            <span id="zoom-level" class="zoom-display">100%</span>
            <button id="btn-zoom-in" class="action-btn" title="Zoom In">+</button>
        </div>
        <div class="action-group">
            <button id="btn-save" class="action-btn btn-save" title="Save Layout">
                <span>üíæ</span> Save Layout
            </button>
            {% if not event %}
            <button id="btn-assign" class="action-btn" onclick="showAssignModal()" title="Assign to Event">
                <span>üìé</span> Assign to Event
            </button>
            {% endif %}
            <button id="btn-clear" class="action-btn btn-danger" title="Clear Canvas">
                <span>üóëÔ∏è</span> Clear Canvas
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="builder-container">
        <!-- Left Toolbar -->
        <div id="toolbar" class="toolbar">
            <h3>Elements</h3>
            <button class="tool" data-type="round-table">
                <span class="tool-icon">‚≠ï</span>
                <span>Round Table</span>
            </button>
            <button class="tool" data-type="rect-table">
                <span class="tool-icon">‚ñ≠</span>
                <span>Rectangle Table</span>
            </button>
            <button class="tool" data-type="chair">
                <span class="tool-icon">ü™ë</span>
                <span>Chair</span>
            </button>
            <button class="tool" data-type="stage">
                <span class="tool-icon">üé≠</span>
                <span>Stage</span>
            </button>
            <button class="tool" data-type="tent">
                <span class="tool-icon">‚õ∫</span>
                <span>Tent</span>
            </button>
            <button class="tool" data-type="buffet">
                <span class="tool-icon">üçΩÔ∏è</span>
                <span>Buffet Table</span>
            </button>
            <button class="tool" data-type="dj-booth">
                <span class="tool-icon">üéß</span>
                <span>DJ Booth</span>
            </button>
            <button class="tool" data-type="text">
                <span class="tool-icon">üìù</span>
                <span>Text Label</span>
            </button>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-wrapper">
            <div id="canvas-container" class="canvas-container">
                <div id="floorplan-canvas"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Info Bar -->
    <div class="info-bar">
        <div class="info-left">
            {% if event %}
            <span class="event-info">Event: <strong>{{ event.title }}</strong> - {{ event.date.strftime('%B %d, %Y') if event.date else 'TBD' }}</span>
            {% endif %}
        </div>
        <div class="info-right">
            <input type="text" id="floor-plan-name" class="name-input" placeholder="Floor Plan Name" value="{% if floorplan %}{{ floorplan.name }}{% elif event %}Floor Plan - {{ event.title }}{% endif %}">
        </div>
    </div>
</div>

<!-- Assign Modal -->
<div id="assign-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Assign Floor Plan to Event</h3>
            <button class="modal-close" onclick="closeAssignModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Select an event to assign this floor plan:</p>
            <select id="event-select" class="form-control">
                <option value="">Select Event...</option>
                {% for evt in events %}
                <option value="{{ evt.id }}" {% if event and evt.id == event.id %}selected{% endif %}>
                    {{ evt.title }} - {{ evt.date.strftime('%B %d, %Y') if evt.date else 'TBD' }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="modal-footer">
            <button onclick="closeAssignModal()" class="btn-secondary">Cancel</button>
            <button onclick="assignFloorPlan()" class="btn-primary">Assign</button>
        </div>
    </div>
</div>

<script>
    const FLOORPLAN_ID = {{ floorplan.id if floorplan else 'null' }};
    {% if floorplan_json and floorplan_json.strip() %}
    const EXISTING_JSON = {{ floorplan_json|tojson|safe }};
    {% else %}
    const EXISTING_JSON = null;
    {% endif %}
    const EVENT_ID = {{ event.id if event else 'null' }};
    const FLOOR_PLAN_ID = {{ floorplan.id if floorplan else 'null' }};
</script>
<script src="{{ url_for('static', filename='js/floorplan_builder.js') }}"></script>
{% endblock %}
