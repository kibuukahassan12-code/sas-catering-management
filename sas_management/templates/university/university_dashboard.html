{% extends "base.html" %}
{% block content %}
<section class="page-header">
    <div>
        <p class="eyebrow">Employee University</p>
        <h1>Learning Dashboard</h1>
        <p class="muted">Track your progress, explore courses, and continue learning.</p>
    </div>
    <div class="quick-links">
        <a class="btn-primary" href="{{ url_for('university.courses_list') }}">Browse All Courses</a>
    </div>
</section>

<!-- KPI Summary Cards -->
<section class="panel">
    <div class="panel-header">
        <h3>Your Learning Overview</h3>
        <span class="badge">Live stats</span>
    </div>
    <div class="summary-grid">
        <article class="summary-card">
            <p>Enrolled Courses</p>
            <h2>{{ total_enrolled }}</h2>
            <small class="muted">{{ completed_courses }} completed</small>
        </article>
        <article class="summary-card">
            <p>In Progress</p>
            <h2>{{ in_progress_courses }}</h2>
            <small class="muted">Keep learning!</small>
        </article>
        <article class="summary-card">
            <p>Average Progress</p>
            <h2>{{ avg_progress }}%</h2>
            <small class="muted">Overall completion</small>
        </article>
        <article class="summary-card">
            <p>Certificates Earned</p>
            <h2>
                {% set cert_count = enrollments|selectattr('completed')|list|length %}
                {{ cert_count }}
            </h2>
            <small class="muted">Keep it up!</small>
        </article>
    </div>
</section>

<!-- My Enrolled Courses -->
{% if enrolled_courses %}
<section class="panel">
    <div class="panel-header">
        <h3>My Courses</h3>
        <a class="btn-secondary btn-sm" href="{{ url_for('university.courses_list') }}">View All</a>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Course</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for course in enrolled_courses %}
                {% set enrollment = enrollments|selectattr('course_id', 'equalto', course.id)|first %}
                <tr>
                    <td>
                        <strong>{{ course.title }}</strong><br>
                        <small class="muted">{{ course.category or 'General' }} â€¢ {{ course.difficulty }}</small>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; background: #e9ecef; border-radius: 4px; height: 8px; overflow: hidden;">
                                <div style="background: #28a745; height: 100%; width: {{ enrollment.progress if enrollment else 0 }}%;"></div>
                            </div>
                            <span style="font-size: 0.875rem; font-weight: 600;">{{ enrollment.progress if enrollment else 0 }}%</span>
                        </div>
                    </td>
                    <td>
                        {% if enrollment and enrollment.completed %}
                        <span class="badge success">âœ“ Completed</span>
                        {% elif enrollment and enrollment.progress > 0 %}
                        <span class="badge warning">In Progress</span>
                        {% else %}
                        <span class="badge">Not Started</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('university.course_view_enhanced', course_id=course.id) }}" class="btn-ghost btn-sm">Continue</a>
                        {% if enrollment and enrollment.completed and enrollment.certificates %}
                        <a href="{{ url_for('university.certificate_view', certificate_id=enrollment.certificates[0].id) }}" class="btn-ghost btn-sm">View Certificate</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<!-- Available Courses -->
{% if available_courses %}
<section class="panel">
    <div class="panel-header">
        <h3>Available Courses</h3>
        <a class="btn-secondary btn-sm" href="{{ url_for('university.courses_list') }}">View All</a>
    </div>
    <div class="course-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
        {% for course in available_courses %}
        <article class="course-card" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; background: white;">
            <div style="margin-bottom: 1rem;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.125rem;">{{ course.title }}</h3>
                {% if course.target_role %}
                <span class="badge">{{ course.target_role.value }}</span>
                {% endif %}
                {% if course.difficulty %}
                <span class="badge badge-secondary">{{ course.difficulty }}</span>
                {% endif %}
            </div>
            <p class="muted" style="margin-bottom: 1rem; font-size: 0.875rem;">{{ course.description[:100] if course.description else 'No description' }}...</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                <small class="muted">
                    {{ course.lessons|length }} lessons
                    {% if course.duration_minutes %}
                    â€¢ {{ course.duration_minutes }} min
                    {% endif %}
                </small>
                <a href="{{ url_for('university.course_view_enhanced', course_id=course.id) }}" class="btn-primary btn-sm">View Course</a>
            </div>
        </article>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Recent Activity -->
{% if recent_enrollments %}
<section class="panel">
    <div class="panel-header">
        <h3>Recent Activity</h3>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Course</th>
                    <th>Enrolled</th>
                    <th>Progress</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for enrollment in recent_enrollments %}
                <tr>
                    <td><strong>{{ enrollment.course.title }}</strong></td>
                    <td>{{ enrollment.enrolled_at.strftime('%Y-%m-%d') }}</td>
                    <td>{{ enrollment.progress }}%</td>
                    <td>
                        {% if enrollment.completed %}
                        <span class="badge success">Completed</span>
                        {% else %}
                        <span class="badge warning">In Progress</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<!-- Leaderboard -->
{% if top_users %}
<section class="panel">
    <div class="panel-header">
        <h3>Top Learners</h3>
        <span class="badge">This month</span>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Learner</th>
                    <th>Courses Completed</th>
                </tr>
            </thead>
            <tbody>
                {% for rank, (user_id, email, completed_count) in top_users|enumerate(start=1) %}
                <tr>
                    <td>
                        {% if rank == 1 %}ðŸ¥‡
                        {% elif rank == 2 %}ðŸ¥ˆ
                        {% elif rank == 3 %}ðŸ¥‰
                        {% else %}#{{ rank }}{% endif %}
                    </td>
                    <td>{{ email }}</td>
                    <td><strong>{{ completed_count }}</strong> courses</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

{% endblock %}

